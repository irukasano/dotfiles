# lf

## 本リポジトリの説明

* ../../Makefile にインストールタスク lf を用意する
* インストールタスクの役割
    * lf をインストール
    * このディレクトリ配下 `bin/` 配下のすべてを `~/.config/lf/bin` 配下にリンクする
    * ただし `bin/lfz` は `~/bin/lfz` へのリンクとする
    * `lfrc`, `icons`, `colors` は `~/.config/lf` 配下にリンクする 
    * `lf.kdl` は `~/.config/zellij/layouts` 配下にリンクする
* lfrc は キーの map を主目的とし、スクリプトは `bin/` に置く

## lf の設定方針

* lf は常に zellij 配下で起動する -> zellij --layout=lf を~/bin/lfz として起動できるようにする
    - すでに zellij 内なら そのまま lf
    - そうでなければ zellij --layout ...    
* 起動直後は 1 ペイン（lf のみ）。右(width=60%)/下(height=30%)/ポップアップはコマンド実行時に生成
    - ポップアップは多重起動禁止（すでに開いていたら閉じるまで次のコマンドは受け付けない）
    - 右ペインはvim用
            - すでにvim開いていたらvimを再利用して同一vim内に開く
    - 下ペインはすべてzellij でスタックする
* スクリプトは ~/.config/lf/bin 配下に集約、lfrc はなるべく map のみでシンプルに定義
* 右/下/ポップアップを開く操作はすべて 共通ランナー（例：~/.config/lf/bin/zz-run）経由にする
    - エラーコード
        - 成功(0)：自動で閉じる
        - 失敗(10)：残す
        - ユーザー入力が必要(20)：終了まで閉じない
    - 右はひとつだけ(vim)、再度指定されたらvim内に開く＝常に20
    - 下はスタックペイン＝コマンド成功時は0, 失敗時は10
    - ポップアップは一つだけ開き再度開こうとした処理はスキップ＝常に20
* キーマップは以下のようにする
    - hjkl は移動、デフォルトのまま
    - デフォルトのプレビューをそのまま使うがテキスト色表示されていないのを改善したい
        - 画像は chafa でプレビュー
        - pdf は pdftotext は1ページのみプレビュー
        - テキスト色表示, source-highlightを使っているのでこれで色付けしたい
            - バイナリは除外し、一定サイズ(2MByte)以上は head を行ベースで 500行
            - headで絞ってからsource-highlight色付けする
        - すべてのプレビュー処理に タイムアウト（例: 200ms〜500ms）を掛ける
                        - タイムアウトしたら「preview truncated / timed out」を出して終わり
    - ,ts でターミナル
        - カーソル配下のディレクトリ、ファイルならそのファイルがあるディレクトリで fish shell をひらく
        - 現在タブの下ペインで表示
        - 複数回 ,ts でも新しい下ペインスタックで作成する
    - ,tt でターミナル
        - カーソル配下のディレクトリ、ファイルならそのファイルがあるディレクトリで fish shell をひらく
        - 新タブで１ペイン表示
    - ,ba でブックマークに追加
        - ディレクトリのみ対象
        - ~/.config/lf/bookmarks.tsv
        - ブックマークファイルの行フォーマットは `path<TAB>tag<TAB>rank` とする
        - 登録時、pathは指定ディレクトリ、rankは1、tag は空欄とする
        - rank 整数が大きい方が優先表示
        - rank,tag 変更は ,be で行う（,ba は追加専用）
        - 重複パス追加は拒否
    - ,be でブックマークファイル編集
            - ブックマークの確認、編集、削除をこれで一本化
            - 右ペイン表示、編集完了後右ペイン閉じる
            - 編集後、保存して閉じたら即反映する
            - ,ba では重複拒否しているが ,be で人が重複をあえてするのはOK
    - ,do で開く
        - fzf で絞り込む
        - 絞り込みは、ブックマーク、最近移動したディレクトリ、他のディレクトリ、の順に優先
        - ブックマーク、最近のディレクトリ、にはアイコンがついているとわかりやすい
        - ブックマークは ,ba のブックマーク
        - 最近ディレクトリはzoxideを利用
        - ポップアップペインで表示
        - 決定後、新しいzellijタブでそのディレクトリをlfで開く
    - ,fo で開く
        - ファイル：xdg-open %f
        - ディレクトリ：xdg-open %d（＝ファイルマネージャが開く想定。環境により何が開くかはOS側に委譲）
        - ただし GUI環境なし／SSH接続されているのであれば、xdg-openしない（処理なし）
    - ,fe で編集
            - file で text なら vim、右ペインにひらく（左はlf）
            - それ以外は ,fo に委譲
        - 選択優先 → なければカーソル下
        - vim 閉じたら右ペインも勝手にとじる
    - ,fx で実行
        - ただし実行権限がある場合のみ
        - 選択優先 → なければカーソル下
        - 絶対パスで実行する
        - 入力用のポップアップペインを表示し、１行入力
        - 実行は下ペインにスタックし、実行成功時も自動でペインを閉じない
    - ,fy でフルパスコピー
        - 選択優先 → なければカーソル下
        - コピー後はステータス行に短く表示（または通知）
    - ,fp は fuzzy find
        - fzf でファイル名検索し（ポップアップペイン）、選択したら閉じてlf がそのファイルを選択状態にする
    - ,fa は ag
        - ag でディレクトリ配下のテキストファイル内検索、ポップアップペイン
        - 単一選択したら閉じて lf がそのファイルを選択状態にする(fzfでENTER)
        - 複数選択不可
        - fzfでCTL+Eで、 vim で開いて(,feと同じ表示)その行にジャンプする
                - file:line:col:match を前提にする
    - ,zp は pack
        - ファイルならそれを圧縮(zip)　→ ファイル名 + .zip を作成
        - ディレクトリならディレクトリごと圧縮 (zip) → ディレクトリ名 + .zip を作成
        - 選択優先 → なければカーソル下
        - 状態は下ペインで表示し、成功終了したら下ペインは勝手に閉じる
    - ,zu は unpack
        - 選択優先 → なければカーソル下
        - 解凍先をfzfで指定
        - 解凍先はディレクトリのみ選べる（ファイルは不可）
                - 候補は ,do と同じものを表示する
                - 候補はポップアップペインで表示
        - 指定しなければ解凍しない
        - 展開前に zipinfo -1 で中身を検査して、.. や絶対パスがあれば拒否
        - 状態は下ペインで表示し、成功終了したら下ペインは勝手に閉じる
    - ,zl は list
        - zip のみ対象
        - ファイル内リストを下ペインに表示、Enter で下ペイン閉じる
    - ,sm は svn commit
        - svn 配下のファイルならそれだけcommit
        - svn 配下のディレクトリならディレクトリごと commit
        - 選択優先 → なければカーソル下
        - commit メッセージは右ペインのvimで入力
        - コミット状態も下ペインで表示、成功なら勝手に閉じる、失敗なら残る
        - git は対応不要
    - ,su は svn update
        - svn 配下のファイルならそれだけ update
        - svn 配下のディレクトリならディレクトリごと update
        - 選択優先 → なければカーソル下
        - update 状態も下ペインで表示、成功なら勝手に閉じる、失敗なら残る
        - git は対応不要
    - ,sh は svn log のファイル変更履歴
        - 下ペインに表示
        - 選択優先 → なければカーソル下
* 以下は標準 map のまま
    - 選択 space, 全選択 v, 全解除 u
    - 移動 d
    - コピー y
    - ペースト p
    - 削除 D
    - リネーム r
    - 標準ブックマーク m{char}
    - 標準ブックマークに移動 '{char}
    


